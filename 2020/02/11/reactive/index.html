<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    PaprikaLang
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="paprikaLang" />
    
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    

    <script  src="/js/jquery.min.js"></script>
    <script  src="/js/jquery.scrollex.min.js"></script>
    <script  src="/js/jquery.scrolly.min.js"></script>
    <script  src="/js/skel.min.js"></script>
    <script  src="/js/util.js"></script>
    <script  src="/js/main.js"></script>
	
<link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_twilight.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">PAPRIKALANG</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/backend/">backend</a></li><li><a class="category-link" href="/categories/redux/">redux</a></li><li><a class="category-link" href="/categories/summary/">summary</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/paprikaLang" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="twitter" href="https://twitter.com/paprikaLang" target="_blank" rel="noopener">
                            <i class="icon fa fa-twitter"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(http://upic.paprikalang.site/paw.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >从 Redux 说开, 再说回来</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <p>&nbsp; </p>
<h2 id="一-可预测的函数式"><a href="#一-可预测的函数式" class="headerlink" title="一   可预测的函数式"></a>一   可预测的函数式</h2><p>&nbsp; </p>
<p>这是一个在移动端按照 redux 状态管理模式构建出来的<a href="https://onevcat.com/2017/07/state-based-viewcontroller/" target="_blank" rel="external">[单向数据流动的函数式 View Controller]</a>. </p>
<p><img src="https://onevcat.com/assets/images/2017/view-controller-states.svg" width="600"></p>
<pre class=" language-swift"><code class="language-swift"><span class="token comment" spellcheck="true">// 图中的 Store 可以对照着 redux 的 createStore 来看</span>
<span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span>A<span class="token punctuation">:</span> <span class="token builtin">ActionType</span><span class="token punctuation">,</span> S<span class="token punctuation">:</span> <span class="token builtin">StateType</span><span class="token punctuation">,</span> C<span class="token punctuation">:</span> <span class="token builtin">CommandType</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// CommandType 是对副作用的抽象化, 同时将 action 从处理副作用的 action creator 中解脱出来. </span>
    <span class="token keyword">let</span> reducer<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">_</span> state<span class="token punctuation">:</span> S<span class="token punctuation">,</span> <span class="token number">_</span> action<span class="token punctuation">:</span> A<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>S<span class="token punctuation">,</span> C<span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> subscriber<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">_</span> state<span class="token punctuation">:</span> S<span class="token punctuation">,</span> <span class="token number">_</span> previousState<span class="token punctuation">:</span> S<span class="token punctuation">,</span> <span class="token number">_</span> command<span class="token punctuation">:</span> C<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">Void</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token keyword">var</span> state<span class="token punctuation">:</span> S

    <span class="token keyword">init</span><span class="token punctuation">(</span>reducer<span class="token punctuation">:</span>@<span class="token function">escaping</span> <span class="token punctuation">(</span>S<span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">(</span>S<span class="token punctuation">,</span> C<span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialState<span class="token punctuation">:</span> S<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>reducer <span class="token operator">=</span> reducer
        <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> initialState
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token number">_</span> handler<span class="token punctuation">:</span> @<span class="token function">escaping</span> <span class="token punctuation">(</span>S<span class="token punctuation">,</span> S<span class="token punctuation">,</span> C<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>subscriber <span class="token operator">=</span> handler
    <span class="token punctuation">}</span>
    <span class="token keyword">func</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     
        <span class="token keyword">self</span><span class="token punctuation">.</span>subscriber <span class="token operator">=</span> <span class="token constant">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">func</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">_</span> action<span class="token punctuation">:</span> A<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> previousState <span class="token operator">=</span> state
        <span class="token keyword">let</span> <span class="token punctuation">(</span>nextState<span class="token punctuation">,</span> command<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        state <span class="token operator">=</span> nextState
        <span class="token comment" spellcheck="true">/*
     订阅了 nextState 的 subscriber 负责更新 UI;
         订阅了 command   的 subscriber 处理副作用, 比如一个异步请求完成后, 
     command 的闭包会接收返回的数据做为 action 的 payload , 再 dispatch 给 reducer.
        */</span>
        subscriber<span class="token operator">?</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> previousState<span class="token punctuation">,</span> command<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>数据可回溯、可预测的关键在于隔离副作用, 确保 reducer 是一个纯函数. <code>Command</code> 和 redux 的 <code>action creator</code> 都是这个目的.</p>
<pre class=" language-swift"><code class="language-swift">  <span class="token comment" spellcheck="true">/*
    测试中, `Command.loadToDos` 的 handler 充当了天然的 `stub`, 
    通过一组 dummy 数据 (["2", "3"]) 就能检查 store 中的状态是否符合预期，
    同时又以同步的方式测试了异步加载的过程.
  */</span>
    <span class="token keyword">let</span> initState <span class="token operator">=</span> <span class="token builtin">TableViewController</span><span class="token punctuation">.</span><span class="token function">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token number">_</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span> <span class="token operator">=</span> controller<span class="token punctuation">.</span><span class="token function">reducer</span><span class="token punctuation">(</span>initState<span class="token punctuation">,</span> <span class="token punctuation">.</span>loadToDos<span class="token punctuation">)</span>
    <span class="token function">XCTAssertNotNil</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> command<span class="token operator">!</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">loadToDos</span><span class="token punctuation">(</span><span class="token keyword">let</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token function">XCTAssertEqual</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span>todos<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&nbsp; </p>
<p>redux 另一种隔离副作用的方法是 <code>中间件</code>, createStore 的第三个参数 <code>applyMiddleware</code> 可以重写 dispatch , 使得 action 在进入 reducer 之前要先经过中间件的处理.</p>
<p><img src="http://upic.paprikalang.site/rxjs-redux.jpg" width="600"></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/* 
   中间件要先校验 action , 校验通过的经过处理后重新 dispatch 一个 action---- 
   校验未通过的传给下一个中间件 ----
   校验都未通过就可以传给 reducer 了.
   自定义中间件的话, action、dispatch、next 都是必需的参数.
*/</span>
<span class="token keyword">const</span> reduxArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> next <span class="token operator">=</span><span class="token operator">></span> action <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> action<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>act <span class="token operator">=</span><span class="token operator">></span> <span class="token function">dispatch</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> reduxThunk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> next <span class="token operator">=</span><span class="token operator">></span> action <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// applyMiddleware 要把中间件像这样垒起来</span>
<span class="token keyword">const</span> reduxThunk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> next <span class="token operator">=</span><span class="token operator">></span> action <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// reduxThunk 的处理</span>
  <span class="token operator">...</span> <span class="token operator">...</span>
  <span class="token keyword">return</span> action <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  
    <span class="token comment" spellcheck="true">// 下游 reduxArray 的处理</span>
    <span class="token operator">...</span> <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token function">next1</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/*
reduxThunk(next) 的返回值   是自己的 action => {},
reduxThunk(next) 的参数next 是 reduxArray(next1) 的返回值 action => {}, 
applyMiddleware  用 reduce 来实现最合适.
*/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> arg <span class="token operator">=</span><span class="token operator">></span> arg
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> fns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> cur<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token function">cur</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> createStore <span class="token operator">=</span><span class="token operator">></span> reducer <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> store
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
      getState<span class="token punctuation">:</span> getState<span class="token punctuation">,</span>
      dispatch<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> middlewareArr <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>middleware <span class="token operator">=</span><span class="token operator">></span> <span class="token function">middleware</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
    dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewareArr<span class="token punctuation">)</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>store<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="二-可分离的响应式"><a href="#二-可分离的响应式" class="headerlink" title="二   可分离的响应式"></a>二   可分离的响应式</h2><p>&nbsp;</p>
<p>中间件 <code>redux-observable</code> 的响应式流可分离一个异步请求的多层回调, 并将每层回调解耦成一个 epic 函数, 函数内部借助 RxJS 操作符可处理复杂的异步操作.</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fetchUser <span class="token operator">=</span> username <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> FETCH_USER<span class="token punctuation">,</span> payload<span class="token punctuation">:</span> username <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fetchUserFulfilled <span class="token operator">=</span> payload <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> FETCH_USER_FULFILLED<span class="token punctuation">,</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// epic 函数: 传入一个 action$ 再返回一个 action$, 内部是业务逻辑</span>
<span class="token keyword">const</span> fetchUserEpic <span class="token operator">=</span> action$ <span class="token operator">=</span><span class="token operator">></span> action$<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
  <span class="token function">ofType</span><span class="token punctuation">(</span>FETCH_USER<span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token function">mergeMap</span><span class="token punctuation">(</span>action <span class="token operator">=</span><span class="token operator">></span>  
    ajax<span class="token punctuation">.</span><span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://api.github.com/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">map</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> <span class="token function">fetchUserFulfilled</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// action 的 type 变成了 FETCH_USER_FULFILLED</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fetchUserFulfilledEpic <span class="token operator">=</span> action$ <span class="token operator">=</span><span class="token operator">></span>
  action$
    <span class="token punctuation">.</span><span class="token function">ofType</span><span class="token punctuation">(</span>FETCH_USER_FULFILLED<span class="token punctuation">)</span>                 
    <span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload<span class="token punctuation">:</span> <span class="token punctuation">{</span> msg <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">showMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token keyword">const</span> rootEpic <span class="token operator">=</span> <span class="token function">combineEpics</span><span class="token punctuation">(</span>fetchUserEpic<span class="token punctuation">,</span> fetchUserFulfilledEpic<span class="token punctuation">)</span>
<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">fetchUser</span><span class="token punctuation">(</span><span class="token string">'torvalds'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&nbsp;</p>
<p>redux-observable 的响应式流还可分离关注点, 让使用者只需专注 epics 之间的业务逻辑而忽略掉 epics 之外的事情.</p>
<!-- <img src="https://cdn.jsdelivr.net/gh/paprikaLang/tti@master/tti/rxjs.jpg" width="500"/> -->
<p><img src="http://upic.paprikalang.site/rxjs.jpg" width="500"></p>
<p>&nbsp;</p>
<p>RxJS 项目在测试时, 也会将一些无关的外部逻辑隔离在 “epic” 函数外, 来提高业务代码的可测试性.</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//生产者</span>
<span class="token keyword">const</span> plus$ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Rx<span class="token punctuation">.</span>Observable<span class="token punctuation">.</span><span class="token function">fromEvent</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#plus'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//观察者</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token punctuation">{</span>
  next<span class="token punctuation">:</span> currentCount <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#count'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> currentCount<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//处理业务逻辑的纯函数 : 传入一个 observable 再返回一个 observable, 内部处理业务逻辑</span>
<span class="token keyword">const</span> counterPipe <span class="token operator">=</span> <span class="token punctuation">(</span>plus$<span class="token punctuation">,</span> minus$<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Rx<span class="token punctuation">.</span>Observable<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>plus$<span class="token punctuation">.</span><span class="token function">mapTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> minus$<span class="token punctuation">.</span><span class="token function">mapTo</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> count <span class="token operator">+</span> delta<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
<span class="token comment" spellcheck="true">/*
可测试性体现在如下方面:
·可以一次只测试一个功能 
·可以很容易制造各种测试前提条件
·可以很容易提高代码的测试覆盖率
·可以很容易模拟被测对象依赖的模块
*/</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Counter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should add &amp; subtract count on source'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> plus <span class="token operator">=</span>     <span class="token string">'^-a------|'</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> minus <span class="token operator">=</span>    <span class="token string">'^---c--d--|'</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> expected <span class="token operator">=</span> <span class="token string">'--x-y--z--|'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result$ <span class="token operator">=</span> <span class="token function">counterPipe</span><span class="token punctuation">(</span><span class="token function">hot</span><span class="token punctuation">(</span>plus<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">hot</span><span class="token punctuation">(</span>minus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expectObservable</span><span class="token punctuation">(</span>result$<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&nbsp;</p>
<p><strong>Flutter</strong> 设计出了框架层面上的业务逻辑组件 —- Bloc ( Business Logic Component):</p>
<p>做为生产者的 sink 可以向 <code>Bloc</code> 内部监听它的 stream 传输数据; 再由另一个 stream (是不同 StreamController 创建的)将处理好的数据传给它的观察者 StreamBuilder 并同步更新这个部件.</p>
<p><img src="https://i.loli.net/2020/04/01/6X8aztKG75lojIi.jpg" width="500"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2 id="三-可预测的函数式-可分离的响应式"><a href="#三-可预测的函数式-可分离的响应式" class="headerlink" title="三   可预测的函数式 + 可分离的响应式"></a>三   可预测的函数式 + 可分离的响应式</h2><p>&nbsp;</p>
<div style="display:flex; justify-content: flex-start;"><br><img src="http://upic.paprikalang.site/rxjs.jpg" width="360" height="180"><br><img src="http://cyclejs.cn/img/cycle-nested-frontpage.svg" width="350"><br></div>    

<p>&nbsp;</p>
<p><strong>Cycle.js</strong> 更进一步, 它的整个应用程序就是一个业务逻辑组件(纯函数); 生产者和观察者合并成了应用程序的执行环境, 不同副作用的资源和底层指令封装在各自的 driver 函数中互不干扰, 并通过读写副作用的流与应用程序进行循环交互.</p>
<p>&nbsp;</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">/*
    这里, 将前面关于 RxJS 测试的例子中的 dom effects 封装成一个 domDriver:
    观察者现在不仅要接收纯函数返回的 observable -- sinks , 
    还要返回本该由生产者交给纯函数的 observable -- sources . 
*/</span>
<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>                
    <span class="token keyword">const</span> click$ <span class="token operator">=</span> sources<span class="token punctuation">.</span>DOM<span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      DOM<span class="token punctuation">:</span> click$<span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> 
     xs<span class="token punctuation">.</span><span class="token function">periodic</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// xstream 可以简单理解为 Rx .</span>
     <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span>prev <span class="token operator">=</span><span class="token operator">></span> prev<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">domDriver</span><span class="token punctuation">(</span>text$<span class="token punctuation">)</span> <span class="token punctuation">{</span>             
  text$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    next<span class="token punctuation">:</span> str <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> elem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#count'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    elem<span class="token punctuation">.</span>textContent <span class="token operator">=</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>    
  <span class="token comment" spellcheck="true">/*
    以上是原观察者, 以下是原生产者. 
    原本分先后的串行结构变成了环形, 这样必然会引出一个问题: circle dependencies of stream.
  */</span>
  <span class="token keyword">const</span> domsource <span class="token operator">=</span> <span class="token function">fromEvent</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">return</span> domsource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span>main<span class="token punctuation">,</span> domDriver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">/*
    用 xstream 的 imitate 解决上面提到的 circle dependencies of stream 问题
    const sinks = main({DOM: domsource});    // 纯函数需要 domDriver 提供的 sources
    const domsource = domDriver(sinks);      // domDriver 需要纯函数返回的 sinks
  */</span>
  <span class="token keyword">const</span> fakeDOMSink <span class="token operator">=</span> xs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> domsource <span class="token operator">=</span> <span class="token function">domDriver</span><span class="token punctuation">(</span>fakeDOMSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sinks <span class="token operator">=</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">{</span>DOM<span class="token punctuation">:</span> domsource<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fakeDOMSink<span class="token punctuation">.</span><span class="token function">imitate</span><span class="token punctuation">(</span>sinks<span class="token punctuation">.</span>DOM<span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span>
</code></pre>
<p>&nbsp;</p>
<blockquote>
<p>在 Cycle.js 中，可以认为“操作系统”就是围绕应用的执行环境。大致来说，DOM、console、JavaScript 和 JS API 都扮演了 web 开发中操作系统的角色。我们需要软件适配器来与浏览器或者其他环境（例如 Node.js）进行交互。Cycle.js 的 driver 就是外界（包括用户以及 JavaScript 执行环境）与 Cycle.js 工具构建的应用世界之间的适配器.</p>
</blockquote>
<p>&nbsp;</p>
<p>cyclejs 中不会出现没有返回值的 dispatch(action) ,  我们需要声明式地消化掉这个方法和它的副作用:</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> addReducer$ <span class="token operator">=</span> actionA$<span class="token punctuation">.</span><span class="token function">mapTo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">addReducer</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 这一步在 driver 中进行, mergedReducer$ 和 state$ 要分别加入到 sinks 和 sources 中.</span>
<span class="token keyword">const</span> state$ <span class="token operator">=</span> mergedReducer$<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&nbsp;</p>
<p>同时, cyclejs 的状态管理模型维持了它的分形结构, 每层模型对应的组件、组件 state$ 对应的状态树节点都需要 isolate 方法剥离出来.</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>state<span class="token punctuation">:</span> reducer$<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">isolate</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token string">'节点'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//节点对应的 reducer 再被上一层包裹起来.</span>
</code></pre>
<blockquote>
<p>When state source crosses the isolation boundary from parent into child, we “peel off” the state object using the isolation scope. Then, when crossing the isolation boundary from child back to the parent, we “wrap” the reducer function using the isolation scope. This layered structure is called an “onion architecture” in other programming contexts(如: koa 中间件的洋葱模型).</p>
</blockquote>
<p>&nbsp;</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>run<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@cycle/run'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>div<span class="token punctuation">,</span> label<span class="token punctuation">,</span> input<span class="token punctuation">,</span> hr<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> makeDOMDriver<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@cycle/dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>withState<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@cycle/state'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> isolate <span class="token keyword">from</span> <span class="token string">'@cycle/isolate'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state$ <span class="token operator">=</span> sources<span class="token punctuation">.</span>state<span class="token punctuation">.</span>stream<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// state object emits { foo, bar, child: { count: 2 } } </span>
  <span class="token keyword">const</span> childSinks <span class="token operator">=</span> <span class="token function">isolate</span><span class="token punctuation">(</span>Child<span class="token punctuation">,</span> <span class="token string">'child'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">const</span> vdom$ <span class="token operator">=</span> state$<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>state <span class="token operator">=</span><span class="token operator">></span> <span class="token comment" spellcheck="true">/* render virtual DOM here */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span> <span class="token operator">...</span>
  <span class="token keyword">const</span> parentReducer$ <span class="token operator">=</span> xs<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>initReducer$<span class="token punctuation">,</span> someOtherReducer$<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> childReducer$ <span class="token operator">=</span> childSinks<span class="token punctuation">.</span>state<span class="token punctuation">;</span> 
  <span class="token keyword">const</span> reducer$ <span class="token operator">=</span> xs<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>parentReducer$<span class="token punctuation">,</span> childReducer$<span class="token punctuation">)</span><span class="token punctuation">;</span> 

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    DOM<span class="token punctuation">:</span> vdom$<span class="token punctuation">,</span>
    state<span class="token punctuation">:</span> reducer$<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> wrappedMain <span class="token operator">=</span> <span class="token function">withState</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span>wrappedMain<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  DOM<span class="token punctuation">:</span> <span class="token function">makeDOMDriver</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>&nbsp; </p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'paprikaLang'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://paprikalang.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://paprikalang.github.io/2020/02/11/reactive/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://paprikalang.github.io/2020/02/11/reactive/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = 'https://paprikalang.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="https://github.com/paprikaLang" style="border-bottom: none;">PAPRIKA</a></li>
            </ul>
        </div>
    </div>
</body>



 	
</html>
