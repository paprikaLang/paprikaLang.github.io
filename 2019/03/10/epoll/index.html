<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    PaprikaLang
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="paprikaLang" />
    
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    

    <script  src="/js/jquery.min.js"></script>
    <script  src="/js/jquery.scrollex.min.js"></script>
    <script  src="/js/jquery.scrolly.min.js"></script>
    <script  src="/js/skel.min.js"></script>
    <script  src="/js/util.js"></script>
    <script  src="/js/main.js"></script>
	
<link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_twilight.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">PAPRIKALANG</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/redux/">redux</a></li><li><a class="category-link" href="/categories/summary/">summary</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/paprikaLang" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="twitter" href="https://twitter.com/paprikaLang" target="_blank" rel="noopener">
                            <i class="icon fa fa-twitter"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(https://upic.paprikalang.site/django.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >Epoll · Canon</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <blockquote>
<p>linux一般使用 non-blocking IO 提高 IO 并发度。当IO并发度很低时，non-blocking IO 不一定比 blocking IO 更高效，因为后者完全由内核负责，而read/write这类系统调用已高度优化，效率显然高于多个线程协作的 non-blocking IO。但当 IO 并发度愈发提高时，blocking IO 阻塞一个线程的弊端便显露出来：内核得不停地在线程间切换才能完成有效的工作，一个 cpu core 上可能只做了一点点事情，就马上又换成了另一个线程，cpu cache 没得到充分利用，另外大量的线程会使得依赖 thread-local 加速的代码性能明显下降，如 tcmalloc ，一旦 malloc 变慢，程序整体性能往往也会随之下降。</p>
</blockquote>
<p><a href=""></a></p>
<blockquote>
<p>而 non-blocking IO 一般由少量 event dispatcher 线程和一些运行用户逻辑的 worker 线程组成，这些线程往往会被复用（换句话说调度工作转移到了用户态），event dispatcher 和 worker 可以同时在不同的核运行（流水线化），内核不用频繁的切换就能完成有效的工作。线程总量也不用很多，所以对 thread-local 的使用也比较充分。这时候 non-blocking IO 就往往比 blocking IO 快了。不过 non-blocking IO 也有自己的问题，它需要调用更多系统调用，比如epoll_ctl，由于 epoll 实现为一棵红黑树，epoll_ctl 并不是一个很快的操作，特别在多核环境下，依赖 epoll_ctl 的实现往往会面临棘手的扩展性问题。non-blocking 需要更大的缓冲，否则就会触发更多的事件而影响效率。non-blocking 还得解决不少多线程问题，代码比 blocking 复杂很多。</p>
</blockquote>
<p><a href=""></a></p>
<blockquote>
<p>asynchronous IO: 无需负责读写，把 buffer 提交给内核后,内核会把数据从内核拷贝到用户态，然后告诉你已可读.</p>
</blockquote>
<p>   —   <a href="https://github.com/eesly/brpc/blob/master/docs/cn/io.md#the-full-picture" target="_blank" rel="external">[三种操作IO的方式]</a></p>
<p><br></p>
<h1 id="OpenResty"><a href="#OpenResty" class="headerlink" title="OpenResty"></a>OpenResty</h1><p><br></p>
<p><strong>OpenResty</strong> 的 <strong>cosocket</strong> 就是基于 nginx_epoll 的 event dispatcher 和 lua 语言的协程特性 实现的:</p>
<p><img src="https://upic.paprikalang.site/openresty.png" width="700"></p>
<p><img src="https://i.loli.net/2019/10/22/s2wuiFUXQl56eOV.jpg" width="700"></p>
<p>Lua 脚本运行在协程上，通过暂停自己（yield)，把网络事件添加到 Nginx 监听列表中，并把运行权限交给 Nginx ; </p>
<p>当网络事件达到触发条件时，会唤醒 (resume）这个协程继续处理. 这样就以同步的模式实现了异步的逻辑.</p>
<pre class=" language-lua"><code class="language-lua"><span class="token keyword">local</span> sock<span class="token punctuation">,</span> err <span class="token operator">=</span> ngx<span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">tcp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> err <span class="token keyword">then</span>
    <span class="token comment" spellcheck="true">-- log</span>
<span class="token keyword">else</span>
    sock<span class="token punctuation">:</span><span class="token function">settimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> sock<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">13370</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">-- nc -l 13370 开启一个 TCP server</span>
    <span class="token keyword">local</span> bytes<span class="token punctuation">,</span> err <span class="token operator">=</span> sock<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'paprikaLang'</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">-- 同步编程模式简单易用</span>
    ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre>
<p>以 ngx.sleep 为例:</p>
<ol>
<li><p>添加 ngx_http_lua_sleep_handler 回调函数;</p>
</li>
<li><p>然后调用 Nginx 提供的接口 ngx_add_timer ，向 Nginx 的事件循环中增加一个定时器; </p>
</li>
<li><p>lua_yield 将 Lua 协程挂起，并把控制权交给 Nginx 的事件循环;</p>
</li>
<li><p>sleep 结束后,  ngx_http_lua_sleep_handler 被触发, 它里面会调用 ngx_http_lua_sleep_resume, lua_resume 最后唤醒了 Lua 协程.</p>
</li>
</ol>
<pre class=" language-lua"><code class="language-lua">static int <span class="token function">ngx_http_lua_ngx_sleep</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    coctx<span class="token operator">-</span><span class="token operator">></span>sleep<span class="token punctuation">.</span>handler <span class="token operator">=</span> ngx_http_lua_sleep_handler<span class="token punctuation">;</span>
    <span class="token function">ngx_add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>coctx<span class="token operator">-</span><span class="token operator">></span>sleep<span class="token punctuation">,</span> <span class="token punctuation">(</span>ngx_msec_t<span class="token punctuation">)</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">lua_yield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果代码中没有 I/O 操作或者 nginx.sleep(0)，而是加解密运算，那么 Lua 协程就会一直占用 LuaJIT VM，直到处理完整个请求也不会交出控制权.</p>
<p>一个简单的 swoole 协程的示例也可以验证 <code>IO密集型任务</code>和 <code>CPU密集型任务</code> 在这方面的差别:</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
<span class="token keyword">use</span> <span class="token package">Swoole<span class="token punctuation">\</span>Coroutine</span> <span class="token keyword">as</span> Co<span class="token punctuation">;</span>
<span class="token function">go</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Co::sleep(1);</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"mysql search ..."</span><span class="token punctuation">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"main"</span><span class="token punctuation">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
<span class="token function">go</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Co::sleep(2);</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"redis search ..."</span><span class="token punctuation">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
输出结果<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
Co<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>模拟的是 <span class="token constant">IO</span>密集型任务<span class="token punctuation">,</span> 会引发协程的调度<span class="token punctuation">,</span> 协程让出控制<span class="token punctuation">,</span> 进入协程调度队列<span class="token punctuation">,</span> <span class="token constant">IO</span> 就绪时恢复运行
<span class="token operator">></span> time php go<span class="token punctuation">.</span>php
 main
 mysql search <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 redis search <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 php go<span class="token punctuation">.</span>php  <span class="token number">0</span><span class="token punctuation">.</span>08s user <span class="token number">0</span><span class="token punctuation">.</span>02s system <span class="token number">4</span><span class="token operator">%</span> cpu <span class="token number">2.107</span> total
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 可以看做是 <span class="token constant">CPU</span>密集型任务<span class="token punctuation">,</span> 不会引起协程的调度
<span class="token operator">></span> time php go<span class="token punctuation">.</span>php
 mysql search <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 main
 redis search <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 php go<span class="token punctuation">.</span>php  <span class="token number">0</span><span class="token punctuation">.</span>10s user <span class="token number">0</span><span class="token punctuation">.</span>05s system <span class="token number">4</span><span class="token operator">%</span> cpu <span class="token number">3.181</span> total
</code></pre>
<p><br></p>
<h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><p><br></p>
<p><strong>Golang</strong> 在 linux 系统下的网络IO系统则是通过 epoll 触发事件唤醒协程 实现了和 openresty 类似的同步模式.</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// +build linux</span>
<span class="token keyword">func</span> <span class="token function">netpollinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                             <span class="token comment" spellcheck="true">// 对应 epollcreate1</span>
    epfd <span class="token operator">=</span> <span class="token function">epollcreate1</span><span class="token punctuation">(</span>_EPOLL_CLOEXEC<span class="token punctuation">)</span>  
    <span class="token operator">...</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// to arm edge-triggered notifications and associate fd with pd</span>
<span class="token keyword">func</span> <span class="token function">netpollopen</span><span class="token punctuation">(</span>fd <span class="token builtin">uintptr</span><span class="token punctuation">,</span> pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">{</span>               <span class="token comment" spellcheck="true">//对应 epollctl</span>
    <span class="token keyword">var</span> ev epollevent
    <span class="token comment" spellcheck="true">// _EPOLLRDHUP 解决了对端socket关闭，epoll本身并不能直接感知到这个关闭动作的问题</span>
    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> _EPOLLIN <span class="token operator">|</span> _EPOLLOUT <span class="token operator">|</span> _EPOLLRDHUP <span class="token operator">|</span> _EPOLLET 
    <span class="token comment" spellcheck="true">// epollwait获取事件之后还会从&amp;ev.data取出pd更改它的状态.</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> pd <span class="token comment" spellcheck="true">//ev.data应该和*pollDesc具有相同的内存结构.</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// returns list of goroutines that become runnable</span>
<span class="token keyword">func</span> <span class="token function">netpoll</span><span class="token punctuation">(</span>block <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>                                    <span class="token comment" spellcheck="true">// 对应 epollwait</span>
    <span class="token keyword">var</span> events <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span>epollevent
    <span class="token operator">...</span> <span class="token operator">...</span>
    n <span class="token operator">:=</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> waitms<span class="token punctuation">)</span>
    <span class="token operator">...</span> <span class="token operator">...</span>
    <span class="token keyword">var</span> gp guintptr
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        ev <span class="token operator">:=</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token operator">...</span> <span class="token operator">...</span>
        <span class="token keyword">if</span> mode <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            pd <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 再调用 netpoll.go 中的 netpollready 函数, 返回一个已经就绪的协程链表</span>
            <span class="token function">netpollready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    <span class="token operator">...</span> <span class="token operator">...</span>
    <span class="token keyword">return</span> gp<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollready</span><span class="token punctuation">(</span>gpp <span class="token operator">*</span>guintptr<span class="token punctuation">,</span> pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> rg<span class="token punctuation">,</span> wg guintptr
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'r'</span> <span class="token operator">||</span> mode <span class="token operator">==</span> <span class="token string">'r'</span><span class="token operator">+</span><span class="token string">'w'</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将pollDesc的状态改成 pdReady 并返回就绪协程的地址</span>
        <span class="token comment" spellcheck="true">// IO事件唤醒协程, 如果true改成false表示超时唤醒</span>
        rg<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">netpollunblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span> <span class="token operator">...</span>
    <span class="token keyword">if</span> rg <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将就绪协程添加至链表中</span>
        rg<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedlink <span class="token operator">=</span> <span class="token operator">*</span>gpp
        <span class="token operator">*</span>gpp <span class="token operator">=</span> rg
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>net.Listen 返回之前要经过:</p>
<p>fd_unix.go 中 netFD 的 Init –&gt; </p>
<p>fd_poll_runtime.go 中 <code>pollDesc</code> 的 init –&gt; </p>
<p>netpoll.go 中的 runtime_pollServerInit –&gt;</p>
<p>一系列方法来生成 EPOLL 单例(serverInit.Do(runtime_pollServerInit)), 然后通过 runtime_pollOpen 将监听事件的 fd 添加到<br>epoll 事件队列中来等待连接事件; 一旦有连接事件 accept 进来, 再用连接事件的 fd 监听数据的读写事件.</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">":8888"</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"listen error: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> 
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">for</span><span class="token punctuation">{</span>
        conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// accept 和 read 内部原理相似, 通过阻塞协程实现同步编程模式</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"accept error: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> 
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span> 
        <span class="token comment" spellcheck="true">// 分配一个新的协程来处理一个新的连接: goroutine-per-connenction</span>
        <span class="token keyword">go</span> <span class="token function">HandleConn</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">HandleConn</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        n<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于non-blocking IO的文件描述符，如果错误是 <code>EAGAIN</code> ,说明 Socket 的缓冲区为空，会阻塞当前协程. </p>
<p>直到这个 连接fd 上再次发生读写事件(或连接事件)，epoll 会通知此协程重新开始运行. </p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        n<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> p<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// syscall.SOCK_NONBLOCK</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">if</span> err <span class="token operator">==</span> syscall<span class="token punctuation">.</span>EAGAIN <span class="token operator">&amp;&amp;</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">pollable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// waitRead 最终调用的接口是: runtime_pollWait</span>
                <span class="token keyword">if</span> err <span class="token operator">=</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">waitRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>isFile<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
                    <span class="token comment" spellcheck="true">// 协程激活后执行continue, 并重新read数据,这时应该没有err可以成功return了.</span>
                    <span class="token keyword">continue</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        err <span class="token operator">=</span> fd<span class="token punctuation">.</span><span class="token function">eofError</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> n<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">poll_runtime_pollWait</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    err <span class="token operator">:=</span> <span class="token function">netpollcheckerr</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//如果返回true，表示是有读写事件发生(old == pdReady)</span>
    <span class="token keyword">for</span> <span class="token operator">!</span><span class="token function">netpollblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        err <span class="token operator">=</span> <span class="token function">netpollcheckerr</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">netpollblock</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">,</span> waitio <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    gpp <span class="token operator">:=</span> <span class="token operator">&amp;</span>pd<span class="token punctuation">.</span>rg
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'w'</span> <span class="token punctuation">{</span>
        gpp <span class="token operator">=</span> <span class="token operator">&amp;</span>pd<span class="token punctuation">.</span>wg
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        old <span class="token operator">:=</span> <span class="token operator">*</span>gpp
        <span class="token keyword">if</span> old <span class="token operator">==</span> pdReady <span class="token punctuation">{</span>
            <span class="token operator">*</span>gpp <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"netpollblock: double wait"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// CAS原子操作, 一种乐观锁: 当 gpp=0 时 将gpp设置为pdWait. 针对连接事件的惊群效应?</span>
        <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span>gpp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pdWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// gopark会阻塞当前协程, 在此之前</span>
    <span class="token comment" spellcheck="true">// 传入的函数指针 netpollblockcommit: casuintptr((*uintptr)(gpp), pdWait,  uintptr(unsafe.Pointer(gp)))</span>
    <span class="token comment" spellcheck="true">// 会将pd.rg从pdWait换成当前协程的地址, 这是为了在netpollunblock时知道该唤醒哪条协程(return (*g)(unsafe.Pointer(old))).</span>
    <span class="token keyword">if</span> waitio <span class="token operator">||</span> <span class="token function">netpollcheckerr</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//gopark调用了mcall，mcall用汇编实现，作用就是把协程挂起.</span>
        <span class="token function">gopark</span><span class="token punctuation">(</span>netpollblockcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"IO wait"</span><span class="token punctuation">,</span> traceEvGoBlockNet<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// atomic_xchg先获取gpp当前状态记录在old中,再 *gpp = 0</span>
    old <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Xchguintptr</span><span class="token punctuation">(</span>gpp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> old <span class="token operator">></span> pdWait <span class="token punctuation">{</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"netpollblock: corrupted state"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> old <span class="token operator">==</span> pdReady
<span class="token punctuation">}</span>
</code></pre>
<p>go-net 的 <code>goroutine-per-connenction</code> 的模式借助 go scheduler 的高效调度, 以同步的方式编写异步逻辑, 简洁易用.</p>
<p>但是如果遇到海量连接并且活跃连接占比又很低的情况, 这种模式会耗费大量无用资源, 性能上也会随之下降. </p>
<p>我们可以先拿餐厅中 <code>顾客-服务员-厨师</code> 这些角色与 <code>connection-goroutine-worker_pool</code>做一个类比, 想一想改进的办法.</p>
<p><br></p>
<h2 id="GNET"><a href="#GNET" class="headerlink" title="GNET"></a>GNET</h2><p><br></p>
<p><code>gnet</code> 重新设计开发了一套 <code>主从多 Reactors + 线程/Go程池</code> 的异步网络模型:</p>
<p><img src="https://upic.paprikalang.site/open3.png" width="700"></p>
<p><strong>mainReactor</strong>(大堂经理):  利用内置的 Round-Robin 轮询负载均衡算法, 将 newConnection 分配给一个 subReator . </p>
<p><strong>subReator</strong>(服务员):      每个 subReator 可以在自己的 epoll 上监听多个 connection 的读写事件, 事件触发时调用 EventHandler.React 处理.</p>
<p><strong>worker pool</strong>(后厨):      不能及时处理的交给 ants 协程池.</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>svr <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">activateMainReactor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> svr<span class="token punctuation">.</span><span class="token function">signalShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> svr<span class="token punctuation">.</span>mainLoop<span class="token punctuation">.</span>poller<span class="token punctuation">.</span><span class="token function">Polling</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> ev <span class="token builtin">uint32</span><span class="token punctuation">,</span> job internal<span class="token punctuation">.</span>Job<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// mainReactor 只负责将监听fd传给acceptNewConnection方法.</span>
        <span class="token keyword">return</span> svr<span class="token punctuation">.</span><span class="token function">acceptNewConnection</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// acceptNewConnection会将连接fd传递给一个subReactor.</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Poller<span class="token punctuation">)</span> <span class="token function">Polling</span><span class="token punctuation">(</span>callback <span class="token keyword">func</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> ev <span class="token builtin">uint32</span><span class="token punctuation">,</span> job internal<span class="token punctuation">.</span>Job<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span> <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        n<span class="token punctuation">,</span> err0 <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">EpollWait</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> el<span class="token punctuation">.</span>events<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// epoll还是event-loop事件驱动的核心</span>
        <span class="token operator">...</span> <span class="token operator">...</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> fd <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Fd<span class="token punctuation">)</span><span class="token punctuation">;</span> fd <span class="token operator">!=</span> p<span class="token punctuation">.</span>wfd <span class="token punctuation">{</span>
                <span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> el<span class="token punctuation">.</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Events<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//异步回调触发的事件</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token operator">...</span> <span class="token operator">...</span>
        <span class="token punctuation">}</span>
        <span class="token operator">...</span> <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>svr <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">acceptNewConnection</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    nfd<span class="token punctuation">,</span> sa<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">==</span> unix<span class="token punctuation">.</span>EAGAIN <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">SetNonblock</span><span class="token punctuation">(</span>nfd<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    lp <span class="token operator">:=</span> svr<span class="token punctuation">.</span>subLoopGroup<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//分配一个subReactor</span>
    c <span class="token operator">:=</span> <span class="token function">newConn</span><span class="token punctuation">(</span>nfd<span class="token punctuation">,</span> lp<span class="token punctuation">,</span> sa<span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> lp<span class="token punctuation">.</span>poller<span class="token punctuation">.</span><span class="token function">Trigger</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">=</span> lp<span class="token punctuation">.</span>poller<span class="token punctuation">.</span><span class="token function">AddRead</span><span class="token punctuation">(</span>nfd<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//AddRead 内部调用了subReactor 内置 epoll 的 unix.EpollCtl</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        lp<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>nfd<span class="token punctuation">]</span> <span class="token operator">=</span> c
        err <span class="token operator">=</span> lp<span class="token punctuation">.</span><span class="token function">loopOpen</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>svr <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">startReactors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    svr<span class="token punctuation">.</span>subLoopGroup<span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> lp <span class="token operator">*</span>loop<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
        svr<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            svr<span class="token punctuation">.</span><span class="token function">activateSubReactor</span><span class="token punctuation">(</span>lp<span class="token punctuation">)</span>
            svr<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>svr <span class="token operator">*</span>server<span class="token punctuation">)</span> <span class="token function">activateSubReactor</span><span class="token punctuation">(</span>lp <span class="token operator">*</span>loop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span> <span class="token operator">...</span> <span class="token comment" spellcheck="true">// 事件循环在每个subReactor内部独立运行, 充分利用多核. </span>
    <span class="token boolean">_</span> <span class="token operator">=</span> lp<span class="token punctuation">.</span>poller<span class="token punctuation">.</span><span class="token function">Polling</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> ev <span class="token builtin">uint32</span><span class="token punctuation">,</span> job internal<span class="token punctuation">.</span>Job<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> c<span class="token punctuation">,</span> ack <span class="token operator">:=</span> lp<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span> ack <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> c<span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token boolean">false</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> ev<span class="token operator">&amp;</span>netpoll<span class="token punctuation">.</span>OutEvents <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> lp<span class="token punctuation">.</span><span class="token function">loopOut</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token keyword">case</span> <span class="token boolean">true</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> ev<span class="token operator">&amp;</span>netpoll<span class="token punctuation">.</span>InEvents <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> lp<span class="token punctuation">.</span><span class="token function">loopIn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//读事件的处理</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>lp <span class="token operator">*</span>loop<span class="token punctuation">)</span> <span class="token function">loopIn</span><span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span> <span class="token operator">...</span>
loopReact<span class="token punctuation">:</span>
    out<span class="token punctuation">,</span> action <span class="token operator">:=</span> lp<span class="token punctuation">.</span>svr<span class="token punctuation">.</span>eventHandler<span class="token punctuation">.</span><span class="token function">React</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//业务逻辑如果在React里阻塞, 整个loop也会阻塞. 需要放置在worker pool里处理.</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> frame<span class="token punctuation">,</span> err <span class="token operator">:=</span> lp<span class="token punctuation">.</span>svr<span class="token punctuation">.</span>codec<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">goto</span> loopReact
    <span class="token punctuation">}</span>
    <span class="token operator">...</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><br></p>
<h1 id="Swoole"><a href="#Swoole" class="headerlink" title="Swoole"></a>Swoole</h1><p><br></p>
<p>Swoole 的流程图能详细地展示 <code>Multi-Reactors</code> 模型的内部运转过程:</p>
<p><img src="https://upic.paprikalang.site/open4.png" width="700"></p>
<p><img src="https://upic.paprikalang.site/open5.png" width="700"></p>
<p><strong>Work Process</strong> 将数据收发和数据处理分离开来，客户端不会关心后台的如何处理数据,它们只需要及时的信息反馈. </p>
<p>Worker Process 发起异步的 Task 任务(类似于 gnet 的 worker pool)用来处理耗时操作,</p>
<p>它的底层使用 Unix Socket 管道通信，是全内存的，没有 IO 消耗. 不同的进程使用不同的管道通信，可以最大化利用多核.</p>
<p><br></p>
<p><em>其他链接</em></p>
<p><a href="https://colobu.com/2019/02/27/1m-go-tcp-connection-2/" target="_blank" rel="external">百万 Go TCP 连接的思考2: 百万连接的吞吐率和延迟</a></p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'paprikaLang'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://paprikalang.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://paprikalang.github.io/2019/03/10/epoll/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://paprikalang.github.io/2019/03/10/epoll/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = 'https://paprikalang.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="https://github.com/paprikaLang" style="border-bottom: none;">PAPRIKA</a></li>
            </ul>
        </div>
    </div>
</body>



 	
</html>
